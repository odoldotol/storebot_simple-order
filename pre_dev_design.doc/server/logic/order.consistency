주문서디비와 결제와 주문스트림 3 부분에서 주문 상태를 관리한다 (+주문서 세션)
=> 3가지중 하나의 문제시 다른 두가지를 통해 복구/보정 가능?




order.place 로직에서 데이터처리부분만 보면 아래와 같음

  세션(구성된 상태로 시작)

order/place
  세션락 SET
  레코드(order) CREATE
  세션업데이트(id) SET
  kakaopay결제준비 HTTP
  세션업데이트(tid) SET

order/approval
  결제승인스트림(pgtoken) ADD

결제승인스트림 READ
  kakaopay결제승인 HTTP
  레코드(order aggregate) CREATE
  주문스트림 ADD
  세션 DEL
  세션락 DEL
  결제승인스트림 ACK


세션락: 결제간 유저의 주문서 세션 수정 막음
결제승인스트림: 외부 결제승인과 내부 주문승인처리간 일관성 확보


회색지대
세션락 SET 이후 죽음 => 세션락 TTL
레코드(order) CREATE 이후 어딘가에서 죽거나 정상적으로 실패시 => 버려진 order 레코드 제거 필요 (approval batch 또는 order batch 에서 처리?)
결제승인스트림 ADD 이후 Redis 죽음 => Redis 가 복구 못하면 주문/결제 시간초과로 실패하거나 / Redis 가 스트림 복구하여 성공/실패 처리하거나
kakaopay결제승인 이후 실패하고 결제취소까지 실패 => 이것도 스트림처리해야할지 고민
세션/세션락 DEL 실패 => 문제 있을까...? 






위험
결제승인된것이 Store Client 에 안뜸 => 메시지 재처리로 방지
결제승인된 주문서 정보가 DB 에 저장안됨 => 메시지 재처리로 방지
결제승인이후 뭔가의 실패로 취소로직 탔으나 결제 취소가 안됨 => 위험함